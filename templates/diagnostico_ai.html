{% extends "base.html" %}

{% block title %}{{ content.diagnostico_ai.title }} - {{ content.site_info.name }}{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="page-header bg-gradient-primary text-white py-5">
    <div class="container">
        <div class="row text-center">
            <div class="col-lg-8 mx-auto">
                <h1 class="display-4 fw-bold mb-4">{{ content.diagnostico_ai.title }}</h1>
                <p class="lead">{{ content.diagnostico_ai.subtitle }}</p>
                <p class="mb-0">{{ content.diagnostico_ai.description }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Características de la IA -->
<section class="ai-features py-5">
    <div class="container">
        <div class="row">
            {% for feature in content.diagnostico_ai.features %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="ai-feature text-center">
                    <div class="feature-icon mb-3">
                        <span class="display-4">{{ feature.icon }}</span>
                    </div>
                    <h5 class="fw-bold mb-3">{{ feature.title }}</h5>
                    <p class="mb-0">{{ feature.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Cómo funciona -->
<section class="how-it-works py-5 bg-light">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-lg-8 mx-auto">
                <h2 class="display-5 fw-bold mb-4">¿Cómo Funciona?</h2>
                <p class="lead text-muted">Nuestro proceso de análisis con IA es simple, rápido y confiable</p>
            </div>
        </div>
        
        <div class="row">
            {% for step in content.diagnostico_ai.how_it_works %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="ai-step text-center">
                    <div class="step-number mx-auto">{{ step.step }}</div>
                    <h5 class="fw-bold mb-3">{{ step.title }}</h5>
                    <p class="text-muted">{{ step.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Herramienta de Diagnóstico IA -->
<section class="ai-tool py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="ai-tool-container bg-white rounded shadow p-4">
                    <h3 class="text-center mb-4">Analizador de Imágenes Médicas</h3>
                    
                    <!-- Área de subida de archivos -->
                    <div class="upload-area border-2 border-dashed border-primary rounded p-5 text-center mb-4" 
                         id="uploadArea">
                        <i class="fas fa-cloud-upload-alt display-4 text-primary mb-3"></i>
                        <h5>Sube tu Imagen Médica</h5>
                        <p class="text-muted">Arrastra y suelta tu archivo aquí o haz clic para seleccionar</p>
                        <p class="small text-muted">Formatos soportados: JPEG, PNG, DICOM (Máx. 10MB)</p>
                        <input type="file" id="imageUpload" class="d-none" accept=".jpg,.jpeg,.png,.dcm">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('imageUpload').click()">
                            Seleccionar Archivo
                        </button>
                    </div>
                    
                    <!-- Previsualización de imagen -->
                    <div id="imagePreview" class="text-center mb-4" style="display: none;">
                        <img id="previewImg" src="" alt="Imagen para análisis" class="img-fluid rounded" style="max-height: 300px;">
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" id="analyzeBtn">
                                <i class="fas fa-robot me-2"></i>Analizar con IA
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" id="clearBtn">
                                <i class="fas fa-trash me-2"></i>Limpiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Área de carga -->
                    <div id="loadingArea" class="text-center py-5" style="display: none;">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <h5>Analizando imagen...</h5>
                        <p class="text-muted">Nuestros algoritmos están procesando tu imagen médica</p>
                    </div>
                    
                    <!-- Resultados del análisis -->
                    <div id="resultsArea" class="mt-4" style="display: none;">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>Resultados del Análisis Preliminar</h5>
                            <div id="analysisResults"></div>
                        </div>
                        
                        <div class="next-steps mt-4">
                            <h6 class="fw-bold">Próximos Pasos Recomendados:</h6>
                            <ul id="recommendations"></ul>
                            
                            <div class="d-flex gap-3 mt-4">
                                <a href="{{ url_for('reserva_cita') }}" class="btn btn-primary">
                                    <i class="fas fa-calendar-alt me-2"></i>Agendar Consulta
                                </a>
                                <a href="{{ url_for('contacto') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-phone me-2"></i>Contactar Especialista
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Disclaimer importante -->
<section class="disclaimer py-4 bg-warning bg-opacity-10">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="alert alert-warning border-warning">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>Aviso Importante
                    </h6>
                    <p class="mb-0">{{ content.diagnostico_ai.disclaimer }}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="cta-section bg-primary text-white py-5">
    <div class="container text-center">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <h2 class="display-5 fw-bold mb-4">¿Necesitas una Evaluación Completa?</h2>
                <p class="lead mb-4">Nuestros especialistas están listos para brindarte un diagnóstico definitivo y personalizado</p>
                
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <a href="{{ url_for('reserva_cita') }}" class="btn btn-light btn-lg">
                        <i class="fas fa-user-md me-2"></i>Consulta con Especialista
                    </a>
                    <a href="{{ url_for('servicios') }}" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-stethoscope me-2"></i>Ver Servicios Completos
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loadingArea = document.getElementById('loadingArea');
    const resultsArea = document.getElementById('resultsArea');
    const analysisResults = document.getElementById('analysisResults');
    const recommendations = document.getElementById('recommendations');

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-success');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        uploadArea.classList.remove('border-success');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-success');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // File input change
    imageUpload.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // Clear button
    clearBtn.addEventListener('click', function() {
        resetForm();
    });

    // Analyze button
    analyzeBtn.addEventListener('click', function() {
        performAnalysis();
    });

    function handleFileSelect(file) {
        // Validar tipo de archivo
        const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        if (!allowedTypes.includes(file.type)) {
            alert('Por favor, selecciona un archivo de imagen válido (JPEG, PNG)');
            return;
        }

        // Validar tamaño (10MB máximo)
        if (file.size > 10 * 1024 * 1024) {
            alert('El archivo es demasiado grande. Máximo 10MB permitido.');
            return;
        }

        // Mostrar previsualización
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            uploadArea.style.display = 'none';
            imagePreview.style.display = 'block';
            resultsArea.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    function resetForm() {
        uploadArea.style.display = 'block';
        imagePreview.style.display = 'none';
        loadingArea.style.display = 'none';
        resultsArea.style.display = 'none';
        imageUpload.value = '';
    }

    function performAnalysis() {
        // Mostrar loading
        imagePreview.style.display = 'none';
        loadingArea.style.display = 'block';

        // Simular análisis de IA (en producción se conectaría con la API real)
        setTimeout(function() {
            loadingArea.style.display = 'none';
            showResults();
        }, 3000);
    }

    function showResults() {
        // Resultados simulados (en producción vendrían de la API)
        const mockResults = {
            confidence: 0.87,
            findings: [
                'Estructura ósea normal en la región analizada',
                'No se observan fracturas evidentes',
                'Densidad ósea dentro de parámetros normales',
                'Se recomienda evaluación clínica complementaria'
            ],
            recommendations: [
                'Consulta con traumatólogo para evaluación completa',
                'Considerar estudios adicionales si persisten síntomas',
                'Seguimiento en 30 días si es necesario'
            ]
        };

        // Mostrar resultados
        analysisResults.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Nivel de Confianza del Análisis:</h6>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${mockResults.confidence * 100}%" 
                             aria-valuenow="${mockResults.confidence * 100}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${(mockResults.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Principales Hallazgos:</h6>
                    <ul class="list-unstyled">
                        ${mockResults.findings.map(finding => `<li><i class="fas fa-check-circle text-success me-2"></i>${finding}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;

        // Mostrar recomendaciones
        recommendations.innerHTML = mockResults.recommendations
            .map(rec => `<li>${rec}</li>`)
            .join('');

        resultsArea.style.display = 'block';
    }
});
</script>
{% endblock %}
